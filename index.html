<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitação de Tarefas</title>
  <link href="https://fonts.googleapis.com/css2?family=Jura:wght@400&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Jura', sans-serif;
      background-color: white;
      color: #333;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #000;
      padding: 1rem 2rem;
      color: #fff;
    }

    .logo {
      width: 100px;
      height: 50px;
      background-color: transparent;
      border-radius: 5px;
      text-align: center;
      line-height: 50px;
      font-weight: bold;
    }

    main {
      max-width: 600px;
      margin: 2rem auto;
      background-color: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #1B1464;
      text-align: center;
    }

    label {
      display: inline-block;
      margin-top: 1rem;
      font-weight: bold;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: 'Jura', sans-serif;
    }

    .radio-group {
      display: flex;
      gap: 2rem;
      margin-top: 0.3rem;
      align-items: center;
      justify-content: flex-start;
      height: auto;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: normal;
      width: auto;
      height: auto;
    }

    .radio-option input[type="radio"] {
      margin: 3px auto 0;
      display: block;
      height: auto;
    }

    .radio-option span {
      white-space: nowrap;
      height: auto;
    }

    button {
      padding: 0.75rem 2rem;
      background: linear-gradient(90deg, #00DBDE 0%, #4A00E0 50%, #8E2DE2 100%);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover {
      opacity: 0.9;
    }

    #mensagem {
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      display: none;
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 5px;
      font-weight: bold;
      text-align: center;
    }

    .sucesso {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .erro {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .loader {
      display: none;
      margin: 1rem auto;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #4A00E0;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<header>
  <h2>Solicitação de Tarefas</h2>
  <div class="logo" style="background-color: transparent; height: 50px; display: flex; align-items: center; justify-content: center;">
  <img src="img/logo.png" alt="Logo Aunica" style="height: 100%; max-height: 50px; object-fit: contain;">
</header>

<main>
  <h1>Formulário de Tarefa</h1>
  <div id="taskForm">
    <label>Tipo da Solicitação</label>
    <div class="radio-group">
      <label class="radio-option">
        <input type="radio" name="tipo" value="consultar" checked>
        <span>Consultar Task</span>
      </label>
      <label class="radio-option">
        <input type="radio" name="tipo" value="criar">
        <span>Criar Task</span>
      </label>
    </div>

    <label for="idProjeto">Projeto</label>
    <select id="idProjeto"></select>

    <div id="tipoTaskGroup" style="display: none;">
      <label>Tipo de Item</label>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="tipoItem" value="task" checked>
          <span>Task</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="tipoItem" value="subtask" disabled>
          <span>Subtask</span>
        </label>
      </div>
    </div>

    <label for="idTask">ID da Task</label>
    <input type="text" id="idTask">

    <div id="nomeTaskGroup">
      <label for="nomeTask">Nome da Task</label>
      <input type="text" id="nomeTask">
    </div>

    <div id="camposExtras" style="display: none;">
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin: 3px;">
        <div style="flex: 1 1 30%; min-width: 150px; margin: 3px;">
          <label for="clienteNome">Cliente</label>
          <input type="text" id="clienteNome" placeholder="Nome do Cliente">
        </div>
        <div style="flex: 1 1 30%; min-width: 150px; margin: 3px;">
          <label for="area">Área</label>
          <input type="text" id="area" placeholder="Design UX, Tech, Dados...">
        </div>
        <div style="flex: 1 1 30%; min-width: 150px; margin: 3px;">
          <label for="tipoTarefa">Tipo de Tarefa</label>
          <input type="text" id="tipoTarefa" placeholder="Documentação, Implementação, Dashboard...">
        </div>
      </div>
    </div>

    <label for="descricao">Descrição da Task</label>
    <textarea id="descricao" rows="4"></textarea>

    <div id="blocoData">
      <label for="dataInicio">Data de Início</label>
      <input type="date" id="dataInicio">

      <label for="dataFim">Data de Fim</label>
      <input type="date" id="dataFim">

      <label for="horasEstimadas">Horas Estimadas</label>
      <input type="number" id="horasEstimadas" min="0" step="0.1">
    </div>

    <div id="blocoPrioridade" style="display: none;">
      <label for="prioridade">Prioridade</label>
      <select id="prioridade">
        <option value="">Selecione a prioridade</option>
        <option value="urgente">Urgente</option>
        <option value="alto">Alto</option>
        <option value="medio">Médio</option>
        <option value="baixo">Baixo</option>
      </select>
    </div>

    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 16px;">
  <button type="button" onclick="enviarTask()">Enviar</button>
  <div id="loader" class="loader" style="width: 24px; height: 24px; margin: 0;"></div>
  <div id="mensagem" style="margin: 0; min-width: 100px; text-align: left;"></div>
</div>
  </div>
</main>

<script>
const camposCondicionais = [
  'idProjeto',
  'nomeTask',
  'descricao',
  'dataInicio',
  'dataFim',
  'horasEstimadas'
].map(id => document.getElementById(id));

const tipoRadios = document.querySelectorAll('input[name="tipo"]');

function toggleFields() {
  const isCriar = document.querySelector('input[name="tipo"]:checked').value === 'criar';
  document.getElementById('blocoData').style.display = isCriar ? 'none' : 'block';
  document.getElementById('blocoPrioridade').style.display = isCriar ? 'block' : 'none';
  document.getElementById('nomeTaskGroup').style.display = isCriar ? 'none' : 'block';
  document.getElementById('camposExtras').style.display = isCriar ? 'block' : 'none';
  document.getElementById('idTask').value = '';
  document.getElementById('nomeTask').value = '';
  document.getElementById('descricao').value = '';
  document.getElementById('dataInicio').value = '';
  document.getElementById('dataFim').value = '';
  document.getElementById('horasEstimadas').value = '';
  document.getElementById('idProjeto').selectedIndex = 0;

  const isConsultar = document.querySelector('input[name="tipo"]:checked').value === 'consultar';
  camposCondicionais.forEach(el => el.disabled = isConsultar);
  document.getElementById('tipoTaskGroup').style.display = isConsultar ? 'none' : 'block';
}

tipoRadios.forEach(radio => radio.addEventListener('change', () => {
  toggleFields();
  carregarProjetos();
}));

window.addEventListener('DOMContentLoaded', () => {
  toggleFields();
  carregarProjetos();
});

function exibirMensagem(texto, sucesso = true) {
  const msg = document.getElementById('mensagem');
  msg.className = sucesso ? 'sucesso' : 'erro';
  msg.textContent = texto;
  msg.style.display = 'block';
  setTimeout(() => msg.style.opacity = '1', 10);
  setTimeout(() => {
    msg.style.opacity = '0';
    setTimeout(() => {
      msg.style.display = 'none';
      msg.textContent = '';
    }, 500);
  }, 2000);
}

const API_URL = 'https://prod-30.brazilsouth.logic.azure.com:443/workflows/e57b8efd7a6b472aae5371054b261c7b/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Zw2AXHRvfhgFshDYj_9el5SdXs8oSi8NeiPqvY4hte8';
const API_URL_PROJECTS = 'https://prod-04.brazilsouth.logic.azure.com:443/workflows/166d18ba5b5b4869ac65a3474387fd0d/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=298XlawPnXeH4RRcSjShQJsBwGc0TDgIYxBJ7Dis0xQ';

const endpoints = {
  consultar: {
    payload: () => ({
      event_name: 'consultar',
      task_id: document.getElementById('idTask').value
    }),
    handleResponse: (data) => {
      document.getElementById('nomeTask').value = data.title || '';
      document.getElementById('descricao').value = data.description ? data.description.replace(/<[^>]*>/g, '') : '';
      document.getElementById('idProjeto').value = data.project_id || '';
      document.getElementById('dataInicio').value = data.datetime ? data.datetime.split(' ')[0] : '';
      document.getElementById('dataFim').value = data.deadline ? data.deadline.split(' ')[0] : '';
      document.getElementById('horasEstimadas').value = data.estimated_hours || '';
    }
  },
  criar: {
    payload: () => ({
      event_name: 'criar',
      project_id: document.getElementById('idProjeto').value,
      title: `${document.getElementById('clienteNome').value} | ${document.getElementById('area').value} | ${document.getElementById('tipoTarefa').value}`,
      description: `<p>${document.getElementById('descricao').value}</p>`,
      prioridade: document.getElementById('prioridade').value,
      tipoItem: document.querySelector('input[name="tipoItem"]:checked')?.value || null
    }),
    handleResponse: () => {
      exibirMensagem('Tarefa criada com sucesso!', true);
    }
  }
};

async function enviarTask() {
  document.getElementById('loader').style.display = 'block';
  const tipo = document.querySelector('input[name="tipo"]:checked').value;
  const endpoint = endpoints[tipo];

  if (!endpoint) {
    exibirMensagem('Tipo de solicitação não suportado.', false);
    return;
  }

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(endpoint.payload())
    });

    if (!response.ok) throw new Error('Erro ao consultar API');

    const data = await response.json();
    endpoint.handleResponse(data);
    document.getElementById('loader').style.display = 'none';

    if (tipo === 'consultar') {
      exibirMensagem('Dados carregados com sucesso!', true);
    }
  } catch (error) {
    console.error('Erro ao enviar ou processar:', error);
    document.getElementById('loader').style.display = 'none';
    exibirMensagem('Erro ao consultar a API. Verifique o console.', false);
  }
}

async function carregarProjetos() {
  try {
    const response = await fetch(API_URL_PROJECTS, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const result = await response.json();
    const select = document.getElementById('idProjeto');
    select.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Selecione um projeto';
    select.appendChild(defaultOption);

    result.data.forEach(project => {
      const option = document.createElement('option');
      option.value = project.id;
      option.textContent = project.name;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Erro ao carregar projetos:', error);
  }
}
</script>
